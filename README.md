# 俯视 ARPG 肉鸽项目学习与实践手册（Godot 4.5）

本仓库用于系统学习与实现一个俯视视角的暗黑类（ARPG 风格）肉鸽游戏。目标是以模块化、数据驱动的方式搭建核心循环（移动 - 战斗 - 掉落 - 成长 - 关卡推进），并兼顾易扩展与可维护性。

本文既是整体设计文档，也是后续开发的执行手册。

**目录**
- 项目结构（目标与演进）
- 开发环境与运行
- 输入映射约定
- 架构与模块划分
- 移动与相机（俯视 ARPG）
- 物品与词缀（数据驱动）
- 战斗与碰撞（层与掩码）
- 程序化关卡（房间模板）
- UI/HUD 规范
- 存档与配置
- 代码风格与命名
- 性能与调试
- 导出与版本
- 学习路线与里程碑

---

## 项目结构（目标与演进）

目标结构（当前工程会逐步演进至此）：

```text
/project_root
|-- addons/                  # Godot 插件
|-- assets/                  # 非代码资源（与引擎无关）
|   |-- environments/        # 3D 环境与材质/模型
|   |-- vfx/                 # 视觉特效素材
|   `-- audio/               # 音频（music/sfx）
|-- core/                    # 全局/引导逻辑
|   |-- main.tscn            # 主入口（加载流程、菜单切换）
|   |-- main.gd
|   |-- globals.gd           # Autoload 单例（配置、工具、RNG）
|   `-- scene_manager.gd     # 场景切换（Autoload）
|-- data/                    # 数据资源（Resource/Tres/Tscn）
|   |-- items/
|   |   |-- bases/
|   |   |-- affixes/
|   |   `-- uniques/
|   `-- skills/
|-- features/                # 领域模块（解耦、互不直接依赖）
|   |-- player/
|   |-- enemies/
|   |-- combat/
|   |-- inventory/
|   |-- procedural_generation/
|   `-- ui/
|-- docs/                    # 设计/规范/研究记录
|-- tests/                   # 测试（如 GUT/WAT）
|-- tools/                   # 导入器、批处理、脚本
|-- project.godot            # Godot 项目文件
`-- export_presets.cfg       # 导出配置（创建导出后生成）
```

新增模块时优先放在 `features/<domain>/`，避免把领域逻辑堆在 `core/`。

## 开发环境与运行

- Godot 版本：4.5（渲染：Forward+）。
- 打开方式：启动 Godot，选择本仓库根目录；或命令行 `godot4 --path .`。
- 运行游戏：在 Godot 中按 `F5`，默认入口为 `core/main.tscn`（如有调整以项目设置为准）。
- 导出配置：在 Godot 中通过“项目 -> 导出”维护，保存到 `export_presets.cfg`，不建议手动编辑该文件。

## 输入映射约定

在「项目设置 -> 输入映射」中约定以下动作（脚本会回退到 `ui_*`，但推荐显式配置）：

- 移动：`move_left` / `move_right` / `move_forward` / `move_back`
- 冲刺/疾跑：`dash` / `sprint`

参考默认绑定（键盘/手柄）：

- WASD / 方向键 / 左摇杆：移动
- Shift：疾跑
- B / Circle：冲刺

## 架构与模块划分

- **Core（引导与单例）**
  - `globals.gd`：配置常量、RNG、全局事件总线。
  - `scene_manager.gd`：场景加载、过场、淡入淡出与存档切换。
- **Features（领域模块）**
  - `player/`：移动、动画、状态机、输入适配。
  - `enemies/`：感知（Ray/Area）、FSM/行为树、掉落钩子。
  - `combat/`：伤害结算、抗性、命中/暴击、敌我识别、硬直与无敌帧。
  - `inventory/`：背包、装备槽、属性汇总、掉落拾取。
  - `procedural_generation/`：房间模板拼接、钥匙/门、事件房/精英/商店。
  - `ui/`：HUD、面板、工具提示、数值飘字。

原则：UI 只展示数据，不直接驱动核心逻辑；核心逻辑对 UI 无依赖。

## 移动与相机（俯视 ARPG）

- 角色在 XZ 平面自由移动，不强调跳跃（可根据设计启用/禁用）。
- 配置项：推荐使用 `move_relative_to_camera = true`，提供“相机相对”移动体验。
- 相机结构：`SpringArm3D/Camera3D`，俯视角固定或轻微跟随主角。
- 角色朝向：
  - 默认朝向移动方向。
  - 后续可扩展“朝向鼠标”或“右摇杆指向”。

## 物品与词缀（数据驱动）

- 物品数据存放路径：`data/items/{bases,affixes,uniques}/*.tres`。
- 推荐结构：
  - **基础物品（Base）**：部位类型、基础数值（伤害、攻速、范围）、可滚词缀槽位。
  - **词缀（Affix）**：前/后缀、权重、数值区间、档位（T1–T5）。
  - **实例（ItemInstance）**：根据关卡进度和“幸运值”等因子抽取并固化最终数值。
- 技能资源：`data/skills/*.tres`，字段包含冷却、施法时间、消耗、投射体/范围参数、受属性加成标签等。

## 战斗与碰撞（层与掩码）

在「项目设置 -> 物理 -> 3D -> 层名称」中建议配置：

1. Player
2. Enemy
3. PlayerHitbox（玩家伤害盒/投射物）
4. EnemyHitbox
5. Environment
6. Loot
7. Interactable
8. Sensor（感知/触发区）

实现要点：

- 命中框与受击框分离（`Area3D + CollisionShape3D`），通过信号回调进行结算。
- 投射体使用对象池复用；命中或超出范围后回收；可参数化穿透、弹射等行为。
- 受击反馈统一交由 `combat` 中心逻辑处理（硬直、击退、无敌帧、浮动伤害数字等）。

## 程序化关卡（房间模板）

- 模板路径：`features/procedural_generation/room_templates/` 用于保存可拼接房间（约定入口/出口锚点）。
- 生成器职责：
  - 根据进度生成“走廊 - 战斗 - 事件 - 奖励”等房间序列。
  - 控制稀有度、精英怪、商店、秘境等权重。
  - 确保房间连接合法（不自交、不出现死路或无法抵达的出口）。

## UI/HUD 规范

- HUD 内容：血量、资源（怒气/法力）、经验条、技能栏、Buff/状态图标、战斗浮动信息。
- 交互提示：物品拾取提示（对准/自动/按键）、装备对比（提升为绿色、降低为红色）。
- 工具提示：从 `data/` 中的资源动态拼装（例如范围、冷却、伤害标签、词缀效果）。
- UI 组件建议集中在 `features/ui/components/`，便于复用和统一风格。

## 存档与配置

- 存档技术选型：
  - 轻量数据：`FileAccess` + JSON。
  - 大量结构化数据：`ResourceSaver` 保存为 `*.tres`。
- 存档内容：
  - 当前 Build（装备、技能、天赋）。
  - 关卡进度（层数、种子、难度）。
  - 用户设置（音量、按键、画质、语言等）。
- 推荐通过 `globals.gd` 暴露统一的 `save_game()` / `load_game()` 接口，并管理本局随机种子。

## 代码风格与命名

> 更详细的贡献规范见根目录 `AGENTS.md`。

- GDScript：
  - 4 空格缩进，UTF-8 编码。
  - 尽量使用类型标注，便于补全和静态检查。
  - 避免在 `_process` 中堆积复杂逻辑，优先用状态机与信号拆分。
- 命名约定：
  - 场景：`PascalCase.tscn`
  - 类名：`PascalCase`
  - 脚本文件：`snake_case.gd`
  - 信号：`something_happened`
  - 常量/枚举：`SCREAMING_SNAKE_CASE`
- 资源与数据：
  - `*.tres` 只存数据，不耦合节点树；脚本读取数据并实例化场景或对象。
- 物理：
  - 清晰配置碰撞层/掩码；避免 Player 直接检测 EnemyHitbox 之外的无关层。

## 性能与调试

- 对象池：对投射体、掉落物、临时特效等频繁创建/销毁的节点进行池化。
- 导航：仅在需要的房间构建 NavMesh，离开房间后及时释放。
- 资源体积：控制贴图分辨率（优先 1K–2K），合理使用压缩和独立的法线/粗糙度贴图。
- 调试工具：
  - `VisibleCollisionShapes`、`DebugDraw`、`NavigationServer` 可视化路径。
  - `RenderingDebugger` 查看渲染瓶颈。

## 导出与版本

- 在 Godot 中通过「项目 -> 导出」添加目标平台预设，保存生成 `export_presets.cfg`。
- 建议采用语义化版本号：`major.minor.patch`。
- 可在 `docs/changelog.md` 中维护简要更新日志（版本、日期、主要改动）。

## 学习路线与里程碑（俯视 ARPG）

建议按以下阶段推进，每一步都产出可运行的“小竖切”：

1. **基础移动与相机**：实现角色在 XZ 平面的移动 + 俯视相机跟随。
2. **基础战斗**：近战轻/重击，受击反馈（闪白、硬直）与伤害数字。
3. **投射体技能**：火球/箭矢类技能，包含冷却、消耗与命中判定。
4. **掉落与背包**：基础物品 + 简单词缀，HUD 提示与装备对比。
5. **敌人 AI**：巡逻/追击/攻击，加入少量精英与特殊能力（冰缓、冲锋等）。
6. **程序化房间与关卡推进**：使用房间模板生成小地图，穿插战斗、事件与商店。
7. **存档系统**：支持本局进度与基础元进度（解锁物品/技能池）。
8. **打磨阶段**：补充 VFX/SFX、数值曲线、手柄震动与可达性（如色弱模式）。

每个阶段完成后，建议在 `docs/` 中记录设计决策与踩坑经验，方便回顾与复用。

